{% extends "base.html" %}

{% block title %}Activity Logs Statistics - Water Permit Management System{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        margin: auto;
        height: 300px;
        width: 100%;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .time-metric {
        font-size: 1.2rem;
        color: #4e73df;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Activity Logs Statistics</h1>
        <div>
            <form class="d-inline-block" method="GET">
                <div class="input-group">
                    <input type="date" class="form-control" name="start_date" value="{{ request.args.get('start_date', '') }}">
                    <input type="date" class="form-control" name="end_date" value="{{ request.args.get('end_date', '') }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter fa-sm"></i> Apply Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row">
        <!-- Total Actions -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 stat-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Actions</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_actions }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Applications -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 stat-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Applications</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_applications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Processing Time -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 stat-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Average Processing Time</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ (stats.average_processing_time / 86400)|round(1) }} days
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Users -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 stat-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Users</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_users }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Time Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Processing Time Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="metric-label">Minimum Processing Time</div>
                            <div class="time-metric">{{ (stats.min_processing_time / 86400)|round(1) }} days</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="metric-label">Average Processing Time</div>
                            <div class="time-metric">{{ (stats.average_processing_time / 86400)|round(1) }} days</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="metric-label">Maximum Processing Time</div>
                            <div class="time-metric">{{ (stats.max_processing_time / 86400)|round(1) }} days</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Actions by Type -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Actions by Type</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="actionsByTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions by Role -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Actions by Role</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="actionsByRoleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time-based Analysis -->
    <div class="row">
        <!-- Actions by Hour -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Actions by Hour of Day</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="actionsByHourChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions by Weekday -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Actions by Day of Week</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="actionsByWeekdayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Analysis -->
    <div class="row">
        <!-- Applications by Type -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Applications by Type</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="applicationsByTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications by Water Source -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Applications by Water Source</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="applicationsByWaterSourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Activity Analysis -->
    <div class="row">
        <!-- Most Active Users -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Most Active Users</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in stats.most_active_users %}
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.role }}</td>
                                    <td>{{ user.action_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Activity by Role -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">User Activity by Role</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userActivityByRoleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Analysis -->
    <div class="row">
        <!-- Documents by Type -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Documents by Type</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="documentsByTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Documents per Application -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Document Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="metric-label">Average Documents per Application</div>
                        <div class="metric-value">{{ stats.average_documents_per_application|round(1) }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Analysis -->
    <div class="row">
        <!-- Comments by Application -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Most Commented Applications</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Application</th>
                                    <th>Comments</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in stats.comments_by_application %}
                                <tr>
                                    <td>{{ app.permit_number }}</td>
                                    <td>{{ app.count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Comments -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Comment Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="metric-label">Total Comments</div>
                        <div class="metric-value">{{ stats.total_comments }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to generate colors
    function generateColors(count) {
        const colors = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#5a5c69', '#858796', '#6f42c1', '#20c9a6', '#fd7e14'
        ];
        return colors.slice(0, count);
    }

    // Actions by Type Chart
    new Chart(document.getElementById('actionsByTypeChart'), {
        type: 'pie',
        data: {
            labels: {{ stats.actions_by_type|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ stats.actions_by_type|map(attribute=1)|list|tojson }},
                backgroundColor: generateColors({{ stats.actions_by_type|length }})
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Actions by Role Chart
    new Chart(document.getElementById('actionsByRoleChart'), {
        type: 'doughnut',
        data: {
            labels: {{ stats.actions_by_role|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ stats.actions_by_role|map(attribute=1)|list|tojson }},
                backgroundColor: generateColors({{ stats.actions_by_role|length }})
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Actions by Hour Chart
    new Chart(document.getElementById('actionsByHourChart'), {
        type: 'bar',
        data: {
            labels: {{ stats.actions_by_hour|map(attribute=0)|list|tojson }},
            datasets: [{
                label: 'Actions',
                data: {{ stats.actions_by_hour|map(attribute=1)|list|tojson }},
                backgroundColor: '#4e73df'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Actions by Weekday Chart
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    new Chart(document.getElementById('actionsByWeekdayChart'), {
        type: 'bar',
        data: {
            labels: {{ stats.actions_by_weekday|map(attribute=0)|list|tojson }}.map(dow => weekdays[dow]),
            datasets: [{
                label: 'Actions',
                data: {{ stats.actions_by_weekday|map(attribute=1)|list|tojson }},
                backgroundColor: '#1cc88a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Applications by Type Chart
    new Chart(document.getElementById('applicationsByTypeChart'), {
        type: 'pie',
        data: {
            labels: {{ stats.applications_by_type|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ stats.applications_by_type|map(attribute=1)|list|tojson }},
                backgroundColor: generateColors({{ stats.applications_by_type|length }})
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Applications by Water Source Chart
    new Chart(document.getElementById('applicationsByWaterSourceChart'), {
        type: 'doughnut',
        data: {
            labels: {{ stats.applications_by_water_source|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ stats.applications_by_water_source|map(attribute=1)|list|tojson }},
                backgroundColor: generateColors({{ stats.applications_by_water_source|length }})
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // User Activity by Role Chart
    new Chart(document.getElementById('userActivityByRoleChart'), {
        type: 'bar',
        data: {
            labels: {{ stats.user_activity_by_role|map(attribute=0)|list|tojson }},
            datasets: [{
                label: 'Users',
                data: {{ stats.user_activity_by_role|map(attribute=1)|list|tojson }},
                backgroundColor: '#4e73df'
            }, {
                label: 'Actions',
                data: {{ stats.user_activity_by_role|map(attribute=2)|list|tojson }},
                backgroundColor: '#1cc88a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Documents by Type Chart
    new Chart(document.getElementById('documentsByTypeChart'), {
        type: 'pie',
        data: {
            labels: {{ stats.documents_by_type|map(attribute=0)|list|tojson }},
            datasets: [{
                data: {{ stats.documents_by_type|map(attribute=1)|list|tojson }},
                backgroundColor: generateColors({{ stats.documents_by_type|length }})
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
});
</script>
{% endblock %}
